<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deleet</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for React and Firebase Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
    
    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .snap-y {
            scroll-snap-type: y mandatory;
        }
        .snap-start {
            scroll-snap-align: start;
        }
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 3s linear infinite;
        }
        @keyframes slide-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-950 text-white overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            doc, 
            updateDoc, 
            deleteDoc, 
            increment, 
            arrayUnion 
        } from 'firebase/firestore';

        // --- CONFIGURATION SECTION ---
        // If hosting on GitHub, you MUST replace the values below with your own Firebase Config keys.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Icons Components ---
        const Icon = ({ path, className, fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Heart = ({ className, fill }) => <Icon className={className} fill={fill ? "currentColor" : "none"} path={<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />} />;
        const MessageCircle = ({ className, fill }) => <Icon className={className} fill={fill} path={<path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />} />;
        const Trash2 = ({ className }) => <Icon className={className} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />;
        const PlusSquare = ({ className }) => <Icon className={className} path={<><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M8 12h8"/><path d="M12 8v8"/></>} />;
        const User = ({ className }) => <Icon className={className} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
        const Send = ({ className }) => <Icon className={className} path={<><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} />;
        const XIcon = ({ className }) => <Icon className={className} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />;
        const Music2 = ({ className }) => <Icon className={className} path={<><circle cx="8" cy="18" r="4"/><path d="M12 18V2l7 4"/></>} />;
        const Share2 = ({ className }) => <Icon className={className} path={<><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></>} />;
        const VideoIcon = ({ className }) => <Icon className={className} path={<><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></>} />;
        const ImageIcon = ({ className }) => <Icon className={className} path={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></>} />;
        const TypeIcon = ({ className }) => <Icon className={className} path={<><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></>} />;
        const HomeIcon = ({ className }) => <Icon className={className} path={<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>} />;
        const PlayIcon = ({ className }) => <Icon className={className} fill="currentColor" path={<polygon points="5 3 19 12 5 21 5 3"></polygon>} />;


        // --- Stock Assets for Demo ---
        const STOCK_VIDEOS = [
            { url: "https://assets.mixkit.co/videos/preview/mixkit-tree-branches-in-the-breeze-1188-large.mp4", thumb: "https://images.unsplash.com/photo-1518495973542-4542c06a5843?w=500" },
            { url: "https://assets.mixkit.co/videos/preview/mixkit-waves-coming-to-the-beach-1166-large.mp4", thumb: "https://images.unsplash.com/photo-1505118380757-91f5f5632de0?w=500" },
            { url: "https://assets.mixkit.co/videos/preview/mixkit-white-cat-lying-among-the-grass-2284-large.mp4", thumb: "https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=500" },
            { url: "https://assets.mixkit.co/videos/preview/mixkit-ink-swirling-in-water-266-large.mp4", thumb: "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=500" },
        ];

        const STOCK_IMAGES = [
            "https://images.unsplash.com/photo-1516233758813-a381c69b1935?w=800",
            "https://images.unsplash.com/photo-1511920170033-f8396924c348?w=800",
            "https://images.unsplash.com/photo-1531297461136-82lw9b44d940?w=800",
            "https://images.unsplash.com/photo-1492691527719-9d1e07e534b4?w=800",
        ];

        // --- View Components ---

        const ProfileView = ({ user, posts }) => {
            const userPosts = posts.filter(p => p.uid === user.uid);
            const totalLikes = userPosts.reduce((acc, curr) => acc + (curr.likes || 0), 0);

            return (
                <div className="flex-1 overflow-y-auto bg-black pt-12 pb-20 animate-slide-up">
                    <div className="flex flex-col items-center gap-3 px-4">
                        <div className="w-24 h-24 rounded-full bg-gradient-to-tr from-cyan-400 to-pink-500 flex items-center justify-center text-4xl font-bold border-4 border-gray-900">
                            {user.username[0].toUpperCase()}
                        </div>
                        <h2 className="text-white font-bold text-xl">@{user.username}</h2>
                        
                        <div className="flex gap-8 mt-2 text-center w-full justify-center border-b border-gray-800 pb-6">
                            <div><div className="font-bold text-white text-lg">0</div><div className="text-gray-400 text-xs">Following</div></div>
                            <div><div className="font-bold text-white text-lg">0</div><div className="text-gray-400 text-xs">Followers</div></div>
                            <div><div className="font-bold text-white text-lg">{totalLikes}</div><div className="text-gray-400 text-xs">Likes</div></div>
                        </div>

                        <div className="flex w-full mt-2">
                             <div className="flex-1 text-center py-3 border-b-2 border-white font-bold cursor-pointer text-sm">Videos</div>
                             <div className="flex-1 text-center py-3 border-b-2 border-transparent text-gray-500 cursor-pointer text-sm">Likes</div>
                             <div className="flex-1 text-center py-3 border-b-2 border-transparent text-gray-500 cursor-pointer text-sm">Private</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-3 gap-0.5 mt-0.5">
                        {userPosts.map(post => (
                            <div key={post.id} className="aspect-[3/4] bg-gray-900 relative group overflow-hidden">
                                {post.type === 'video' ? (
                                    <video src={post.contentUrl} className="w-full h-full object-cover opacity-80" />
                                ) : post.type === 'image' ? (
                                    <img src={post.contentUrl} className="w-full h-full object-cover opacity-80" />
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center bg-gradient-to-br from-indigo-900 to-purple-900 p-2 text-[8px] text-center">{post.text}</div>
                                )}
                                <div className="absolute bottom-1 left-2 flex items-center text-xs font-bold text-white drop-shadow-md">
                                    <PlayIcon className="w-3 h-3 mr-1" /> {post.likes}
                                </div>
                            </div>
                        ))}
                        {userPosts.length === 0 && (
                            <div className="col-span-3 text-center py-10 text-gray-500 text-sm">
                                No posts yet. <br/> Tap the + to create one!
                            </div>
                        )}
                    </div>
                </div>
            )
        };

        const InboxView = () => (
             <div className="flex-1 overflow-y-auto bg-black pt-14 pb-20 animate-slide-up px-4">
                <h2 className="text-xl font-bold mb-6">Activity</h2>
                <div className="space-y-4">
                    <div className="flex gap-3 items-center">
                        <div className="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center font-bold">D</div>
                        <div>
                            <p className="text-sm font-bold">System Notification</p>
                            <p className="text-xs text-gray-400">Welcome to Deleet! Start posting anonymously.</p>
                        </div>
                        <button className="ml-auto bg-pink-500 px-3 py-1 rounded text-xs font-bold">Open</button>
                    </div>
                     {[1,2,3].map(i => (
                        <div key={i} className="flex gap-3 items-center">
                            <div className="w-12 h-12 rounded-full bg-gray-800 flex items-center justify-center font-bold text-gray-500">?</div>
                            <div>
                                <p className="text-sm font-bold">Anonymous User</p>
                                <p className="text-xs text-gray-400">liked your post. {i}h ago</p>
                            </div>
                            <div className="ml-auto w-10 h-10 bg-gray-800 rounded"></div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const FriendsView = () => (
             <div className="flex-1 overflow-y-auto bg-black pt-14 pb-20 animate-slide-up px-4">
                <h2 className="text-xl font-bold mb-6">Discover Friends</h2>
                <div className="bg-gray-900 p-4 rounded-xl mb-6 flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center"><User className="w-5 h-5"/></div>
                    <div className="flex-1">
                        <p className="font-bold text-sm">Invite Friends</p>
                        <p className="text-xs text-gray-400">Connect with contacts</p>
                    </div>
                    <button className="bg-pink-500 px-4 py-2 rounded-full text-xs font-bold">Invite</button>
                </div>
                
                <h3 className="text-sm font-bold text-gray-400 mb-4">Suggested Accounts</h3>
                <div className="space-y-4">
                    {['Ghost', 'Shadow', 'Mystery', 'Echo'].map((name, i) => (
                        <div key={i} className="flex gap-3 items-center">
                             <div className="w-12 h-12 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center font-bold">{name[0]}</div>
                             <div className="flex-1">
                                <p className="font-bold text-sm">@{name.toLowerCase()}</p>
                                <p className="text-xs text-gray-400">Suggested for you</p>
                             </div>
                             <button className="bg-pink-500 px-6 py-1.5 rounded-sm text-xs font-bold">Follow</button>
                        </div>
                    ))}
                </div>
            </div>
        );

        const FeedView = ({ posts, user, activeIndex, setActiveIndex, onScroll }) => (
            <div 
                onScroll={onScroll}
                className="flex-1 overflow-y-scroll snap-y snap-mandatory scrollbar-hide bg-black"
                style={{ scrollBehavior: 'smooth' }}
            >
                {posts.length === 0 ? (
                    <div className="h-full w-full flex flex-col items-center justify-center text-gray-500 snap-start">
                        <div className="mb-4 p-4 rounded-full bg-gray-900"><VideoIcon className="w-8 h-8" /></div>
                        <p>No posts yet.</p>
                        <p className="text-xs mt-2">Be the first to post!</p>
                    </div>
                ) : (
                    posts.map((post, index) => (
                        <div key={post.id} className="w-full h-full snap-start relative">
                            <PostItem 
                                post={post} 
                                isActive={index === activeIndex} 
                                currentUser={user}
                            />
                        </div>
                    ))
                )}
            </div>
        );

        const CommentModal = ({ post, isOpen, onClose, currentUser }) => {
            const [newComment, setNewComment] = useState('');
            const [localComments, setLocalComments] = useState(post.comments || []);

            useEffect(() => {
                setLocalComments(post.comments || []);
            }, [post.comments]);

            const handleSend = async (e) => {
                e.preventDefault();
                if (!newComment.trim()) return;

                const commentData = {
                    username: currentUser.username || 'Anon',
                    text: newComment,
                    timestamp: Date.now()
                };

                setLocalComments([...localComments, commentData]);
                setNewComment('');

                try {
                    const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', post.id);
                    await updateDoc(postRef, {
                        comments: arrayUnion(commentData)
                    });
                } catch (err) {
                    console.error("Failed to comment", err);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-black/50 pointer-events-auto" onClick={onClose} />
                    <div className="bg-white dark:bg-gray-900 w-full sm:w-[400px] h-[70vh] rounded-t-2xl sm:rounded-2xl flex flex-col pointer-events-auto shadow-2xl animate-slide-up">
                        <div className="p-4 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center">
                            <h3 className="font-bold text-gray-900 dark:text-white">{localComments.length} comments</h3>
                            <button onClick={onClose}><XIcon className="w-6 h-6 text-gray-500" /></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {localComments.length === 0 ? (
                                <div className="text-center text-gray-500 mt-10">No comments yet. Be the first!</div>
                            ) : (
                                localComments.map((c, i) => (
                                    <div key={i} className="flex gap-3">
                                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-pink-500 to-orange-400 flex items-center justify-center text-white text-xs font-bold shrink-0">
                                            {c.username[0].toUpperCase()}
                                        </div>
                                        <div>
                                            <div className="text-xs font-bold text-gray-600 dark:text-gray-300">{c.username}</div>
                                            <div className="text-sm text-gray-800 dark:text-gray-100">{c.text}</div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        <form onSubmit={handleSend} className="p-3 border-t border-gray-200 dark:border-gray-800 flex gap-2">
                            <input 
                                value={newComment}
                                onChange={(e) => setNewComment(e.target.value)}
                                placeholder="Add a nice comment..."
                                className="flex-1 bg-gray-100 dark:bg-gray-800 rounded-full px-4 py-2 text-sm outline-none text-gray-900 dark:text-white"
                            />
                            <button type="submit" className="p-2 text-pink-500 font-bold"><Send className="w-5 h-5" /></button>
                        </form>
                    </div>
                </div>
            );
        };

        const PostItem = ({ post, isActive, currentUser }) => {
            const videoRef = useRef(null);
            const [showComments, setShowComments] = useState(false);
            const [liked, setLiked] = useState(false);
            const [deleteVoted, setDeleteVoted] = useState(false);

            useEffect(() => {
                if (isActive && post.type === 'video' && videoRef.current) {
                    videoRef.current.currentTime = 0;
                    videoRef.current.play().catch(e => console.log("Autoplay prevented", e));
                } else if (post.type === 'video' && videoRef.current) {
                    videoRef.current.pause();
                }
            }, [isActive, post.type]);

            const handleLike = async () => {
                if (liked) return;
                setLiked(true);
                const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', post.id);
                await updateDoc(postRef, { likes: increment(1) });
            };

            const handleVoteDelete = async () => {
                if (deleteVoted) return;
                setDeleteVoted(true);
                
                const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', post.id);
                
                if ((post.deleteVotes || 0) + 1 >= 10) {
                    await deleteDoc(postRef);
                } else {
                    await updateDoc(postRef, { deleteVotes: increment(1) });
                }
            };

            return (
                <div className="relative w-full h-full snap-start shrink-0 flex items-center justify-center bg-black overflow-hidden">
                    <div className="absolute inset-0 bg-gray-900 flex items-center justify-center">
                        {post.type === 'video' && (
                            <video 
                                ref={videoRef}
                                src={post.contentUrl} 
                                className="w-full h-full object-cover"
                                loop
                                muted
                                playsInline
                            />
                        )}
                        {post.type === 'image' && (
                            <img 
                                src={post.contentUrl} 
                                className="w-full h-full object-cover" 
                                alt="Post"
                            />
                        )}
                        {post.type === 'text' && (
                            <div className="w-full h-full bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center p-8 text-center">
                                <h2 className="text-2xl sm:text-4xl font-bold text-white leading-tight break-words shadow-sm">
                                    "{post.text}"
                                </h2>
                            </div>
                        )}
                    </div>

                    <div className="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/80 pointer-events-none"></div>

                    <div className="absolute right-2 bottom-20 flex flex-col items-center gap-6 z-10 pointer-events-auto">
                        <div className="flex flex-col items-center gap-1">
                            <div className="w-12 h-12 rounded-full border-2 border-white p-0.5 overflow-hidden bg-black">
                                <div className="w-full h-full rounded-full bg-gradient-to-br from-yellow-400 to-red-500 flex items-center justify-center text-white font-bold text-sm">
                                    {post.username[0].toUpperCase()}
                                </div>
                            </div>
                        </div>

                        <button onClick={handleLike} className="flex flex-col items-center gap-1 group">
                            <div className={`p-2 rounded-full bg-black/20 backdrop-blur-sm transition-transform group-active:scale-90 ${liked ? 'text-red-500' : 'text-white'}`}>
                                <Heart className={`w-8 h-8 ${liked ? 'fill-current' : ''}`} />
                            </div>
                            <span className="text-white text-xs font-semibold">{post.likes || 0}</span>
                        </button>

                        <button onClick={() => setShowComments(true)} className="flex flex-col items-center gap-1 group">
                            <div className="p-2 rounded-full bg-black/20 backdrop-blur-sm text-white transition-transform group-active:scale-90">
                                <MessageCircle className="w-8 h-8 fill-white/20" />
                            </div>
                            <span className="text-white text-xs font-semibold">{(post.comments || []).length}</span>
                        </button>

                        <button onClick={handleVoteDelete} className="flex flex-col items-center gap-1 group">
                            <div className={`p-2 rounded-full bg-black/20 backdrop-blur-sm transition-transform group-active:scale-90 ${deleteVoted ? 'text-red-500' : 'text-white'}`}>
                                <Trash2 className="w-8 h-8" />
                            </div>
                            <span className="text-white text-[10px] font-semibold text-center w-12 leading-none">
                                {post.deleteVotes || 0}/10<br/>to del
                            </span>
                        </button>
                    </div>

                    <div className="absolute bottom-0 left-0 w-full p-4 pb-6 pr-16 bg-gradient-to-t from-black/90 to-transparent pointer-events-none">
                        <div className="pointer-events-auto">
                            <h3 className="font-bold text-white text-lg drop-shadow-md">@{post.username}</h3>
                            <p className="text-white/90 text-sm mt-2 line-clamp-3 font-medium drop-shadow-md">
                                {post.caption}
                                {post.type === 'text' && " #thought"}
                                {post.type === 'video' && " #video"}
                                {post.type === 'image' && " #photo"}
                            </p>
                            <div className="flex items-center gap-2 mt-3 text-white/70 text-xs">
                                <Music2 className="w-3 h-3 animate-spin-slow" />
                                <span>Original Sound - {post.username}</span>
                            </div>
                        </div>
                    </div>

                    <CommentModal 
                        post={post} 
                        isOpen={showComments} 
                        onClose={() => setShowComments(false)}
                        currentUser={currentUser}
                    />
                </div>
            );
        };

        const CreatePostModal = ({ isOpen, onClose, currentUser }) => {
            const [type, setType] = useState('text');
            const [text, setText] = useState('');
            const [caption, setCaption] = useState('');
            const [selectedMedia, setSelectedMedia] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);

            if (!isOpen) return null;

            const handleSubmit = async () => {
                if (type === 'text' && !text) return;
                if ((type === 'video' || type === 'image') && !selectedMedia) return;

                setIsSubmitting(true);
                try {
                    const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
                    await addDoc(postsRef, {
                        type,
                        text: type === 'text' ? text : null,
                        contentUrl: selectedMedia,
                        caption: caption || 'Check this out!',
                        username: currentUser.username,
                        uid: currentUser.uid,
                        likes: 0,
                        deleteVotes: 0,
                        comments: [],
                        createdAt: Date.now()
                    });
                    onClose();
                    setText('');
                    setCaption('');
                    setSelectedMedia(null);
                } catch (e) {
                    console.error("Post failed", e);
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
                    <div className="bg-gray-900 w-full max-w-md rounded-2xl overflow-hidden border border-gray-800 flex flex-col max-h-[90vh]">
                        <div className="p-4 flex justify-between items-center border-b border-gray-800">
                            <h2 className="text-white font-bold text-lg">New Post</h2>
                            <button onClick={onClose}><XIcon className="text-white" /></button>
                        </div>

                        <div className="flex p-2 gap-2 bg-gray-900">
                            {['text', 'image', 'video'].map(t => (
                                <button 
                                    key={t}
                                    onClick={() => { setType(t); setSelectedMedia(null); }}
                                    className={`flex-1 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${type === t ? 'bg-white text-black' : 'bg-gray-800 text-gray-400'}`}
                                >
                                    {t === 'text' && <TypeIcon className="w-4 h-4"/>}
                                    {t === 'image' && <ImageIcon className="w-4 h-4"/>}
                                    {t === 'video' && <VideoIcon className="w-4 h-4"/>}
                                    {t.charAt(0).toUpperCase() + t.slice(1)}
                                </button>
                            ))}
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {type === 'text' ? (
                                <textarea 
                                    className="w-full h-40 bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-xl p-6 text-white text-xl font-bold placeholder-white/50 outline-none resize-none"
                                    placeholder="What's on your mind?"
                                    value={text}
                                    onChange={e => setText(e.target.value)}
                                />
                            ) : (
                                <div className="space-y-4">
                                    <p className="text-gray-400 text-sm">Select a stock {type}:</p>
                                    <div className="grid grid-cols-2 gap-2">
                                        {type === 'video' && STOCK_VIDEOS.map((vid, i) => (
                                            <div 
                                                key={i} 
                                                onClick={() => setSelectedMedia(vid.url)}
                                                className={`relative aspect-[9/16] rounded-lg overflow-hidden cursor-pointer border-4 ${selectedMedia === vid.url ? 'border-pink-500' : 'border-transparent'}`}
                                            >
                                                <img src={vid.thumb} className="w-full h-full object-cover opacity-80" alt="stock" />
                                                <div className="absolute inset-0 flex items-center justify-center"><VideoIcon className="text-white" /></div>
                                            </div>
                                        ))}
                                        {type === 'image' && STOCK_IMAGES.map((img, i) => (
                                            <div 
                                                key={i} 
                                                onClick={() => setSelectedMedia(img)}
                                                className={`relative aspect-square rounded-lg overflow-hidden cursor-pointer border-4 ${selectedMedia === img ? 'border-pink-500' : 'border-transparent'}`}
                                            >
                                                <img src={img} className="w-full h-full object-cover opacity-80" alt="stock" />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="space-y-2">
                                <label className="text-gray-400 text-sm">Caption</label>
                                <input 
                                    className="w-full bg-gray-800 text-white rounded-lg p-3 outline-none focus:ring-1 focus:ring-pink-500"
                                    placeholder="#Hashtags @Friends"
                                    value={caption}
                                    onChange={e => setCaption(e.target.value)}
                                />
                            </div>
                        </div>

                        <div className="p-4 border-t border-gray-800">
                            <button 
                                disabled={isSubmitting}
                                onClick={handleSubmit}
                                className="w-full py-3 bg-pink-500 hover:bg-pink-600 active:bg-pink-700 text-white font-bold rounded-xl transition-colors disabled:opacity-50"
                            >
                                {isSubmitting ? 'Posting...' : 'Post'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [username, setUsername] = useState(localStorage.getItem('deleet_username') || '');
            const [hasJoined, setHasJoined] = useState(!!username);
            const [posts, setPosts] = useState([]);
            const [showCreate, setShowCreate] = useState(false);
            const [currentTab, setCurrentTab] = useState('home'); // home, friends, inbox, profile
            const feedRef = useRef(null);
            const [activeIndex, setActiveIndex] = useState(0);

            // Auth
            useEffect(() => {
                const initAuth = async () => {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                
                return onAuthStateChanged(auth, (u) => {
                    if (u) setUser({ uid: u.uid, username });
                });
            }, []);

            // Keep user object fresh if username changes
            useEffect(() => {
                if (auth.currentUser) {
                    setUser({ uid: auth.currentUser.uid, username });
                }
            }, [username]);

            // Posts Listener
            useEffect(() => {
                if (!user) return;
                
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    fetchedPosts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    setPosts(fetchedPosts);
                }, (error) => {
                    console.error("Error fetching posts:", error);
                });

                return () => unsubscribe();
            }, [user]);

            // Scroll Observer (Only attach when feed is visible)
            useEffect(() => {
                if (currentTab !== 'home') return;
                
                const container = feedRef.current;
                if (!container) return;

                const handleScroll = () => {
                    const index = Math.round(container.scrollTop / container.clientHeight);
                    setActiveIndex(index);
                };

                container.addEventListener('scroll', handleScroll);
                return () => container.removeEventListener('scroll', handleScroll);
            }, [posts, currentTab]);

            const handleJoin = (e) => {
                e.preventDefault();
                if (!username.trim()) return;
                localStorage.setItem('deleet_username', username);
                setHasJoined(true);
            };

            if (!hasJoined) {
                return (
                    <div className="min-h-screen bg-black flex items-center justify-center p-4">
                        <div className="w-full max-w-md bg-gray-900 rounded-3xl p-8 border border-gray-800 text-center">
                            <div className="w-20 h-20 bg-gradient-to-tr from-cyan-400 to-pink-500 rounded-2xl mx-auto mb-6 flex items-center justify-center">
                                <Music2 className="w-10 h-10 text-white" />
                            </div>
                            <h1 className="text-3xl font-bold text-white mb-2">Deleet</h1>
                            <p className="text-gray-400 mb-8">Enter a username to join the anonymous feed.</p>
                            <form onSubmit={handleJoin} className="space-y-4">
                                <input 
                                    type="text" 
                                    placeholder="@username"
                                    className="w-full bg-gray-800 border border-gray-700 rounded-xl p-4 text-white text-center text-lg outline-none focus:border-pink-500 transition-colors"
                                    value={username}
                                    onChange={e => setUsername(e.target.value.replace(/\s/g, '').toLowerCase())}
                                    autoFocus
                                />
                                <button 
                                    type="submit" 
                                    className="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 rounded-xl transition-transform active:scale-95"
                                >
                                    Start Watching
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex justify-center bg-gray-950 h-screen w-full overflow-hidden">
                    <div className="relative w-full max-w-[450px] h-full bg-black shadow-2xl flex flex-col">
                        
                        {/* Header Overlay (Only for Home) */}
                        {currentTab === 'home' && (
                            <div className="absolute top-0 left-0 w-full z-20 p-4 pt-6 bg-gradient-to-b from-black/80 to-transparent flex justify-between items-start pointer-events-none">
                                <div className="flex gap-4 text-white font-bold text-lg pointer-events-auto">
                                    <span className="text-gray-400 font-normal">Following</span>
                                    <span className="border-b-2 border-white pb-1">For You</span>
                                </div>
                            </div>
                        )}

                        {/* Main Content Area */}
                        {currentTab === 'home' && (
                            <div className="flex-1 h-full relative" ref={feedRef} style={{overflow: 'hidden'}}>
                                <FeedView 
                                    posts={posts} 
                                    user={user} 
                                    activeIndex={activeIndex} 
                                    setActiveIndex={setActiveIndex} 
                                    onScroll={(e) => {
                                         const index = Math.round(e.target.scrollTop / e.target.clientHeight);
                                         setActiveIndex(index);
                                    }}
                                />
                            </div>
                        )}
                        {currentTab === 'friends' && <FriendsView />}
                        {currentTab === 'inbox' && <InboxView />}
                        {currentTab === 'profile' && <ProfileView user={user} posts={posts} />}

                        {/* Bottom Nav */}
                        <div className="absolute bottom-0 left-0 w-full h-16 bg-black flex justify-around items-center border-t border-gray-800 z-30">
                            <button 
                                onClick={() => setCurrentTab('home')}
                                className={`flex flex-col items-center gap-1 ${currentTab === 'home' ? 'text-white' : 'text-gray-500'}`}
                            >
                                <HomeIcon className="w-6 h-6" />
                                <span className="text-[10px]">Home</span>
                            </button>
                            
                            <button 
                                onClick={() => setCurrentTab('friends')}
                                className={`flex flex-col items-center gap-1 ${currentTab === 'friends' ? 'text-white' : 'text-gray-500'}`}
                            >
                                <Share2 className="w-5 h-5" />
                                <span className="text-[10px]">Friends</span>
                            </button>

                            <button onClick={() => setShowCreate(true)} className="relative -top-3">
                                <div className="w-12 h-8 bg-gradient-to-r from-cyan-400 to-pink-500 rounded-lg flex items-center justify-center hover:scale-105 transition-transform">
                                    <div className="w-6 h-6 bg-black rounded flex items-center justify-center">
                                        <PlusSquare className="w-4 h-4 text-white" />
                                    </div>
                                </div>
                            </button>

                            <button 
                                onClick={() => setCurrentTab('inbox')}
                                className={`flex flex-col items-center gap-1 ${currentTab === 'inbox' ? 'text-white' : 'text-gray-500'}`}
                            >
                                <MessageCircle className="w-5 h-5" />
                                <span className="text-[10px]">Inbox</span>
                            </button>

                            <button 
                                onClick={() => setCurrentTab('profile')}
                                className={`flex flex-col items-center gap-1 ${currentTab === 'profile' ? 'text-white' : 'text-gray-500'}`}
                            >
                                <User className="w-5 h-5" />
                                <span className="text-[10px]">Profile</span>
                            </button>
                        </div>

                        <CreatePostModal 
                            isOpen={showCreate} 
                            onClose={() => setShowCreate(false)} 
                            currentUser={user} 
                        />
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
